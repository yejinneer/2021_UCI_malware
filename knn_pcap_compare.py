import numpy as np 
import pandas as pd 
import matplotlib.pyplot as plt

def Similarity_binary(packet_sample_1, packet_sample_2):
    similarity_int = 0
    d1 = pd.DataFrame(packet_sample_1)
    df1 = d1.to_string().split()
    d2 = pd.DataFrame(packet_sample_2)
    df2 = d2.to_string().split()

    #Smac
    if df1[14] == df2[14]:
        similarity_int += 1
    #Dmac
    if df1[15] == df2[15]:
        similarity_int += 1
    #Sip
    if df1[16] == df2[16]:
        similarity_int += 1
    #Dip
    if df1[17] == df2[17]:
        similarity_int += 1
    #Sport
    if abs(int(df1[18]) - int(df2[18])) <= 10:
        similarity_int += 1
    #Dport
    if abs(int(df1[19]) - int(df2[19])) <= 10:
        similarity_int += 1
    similarity_int /= 6
    #print("Similarity  = " , similarity_int)
    return similarity_int


# Main logic for normal packets
normal_packet_family_list = []         # Each cluster
normal_packet_parent_list = []
normal_packet_checklist = [0]*48      # Check if packet is in cluster
normal_data = pd.read_csv('http_final_revise.csv', encoding="euc-kr")

# 48 packets in this normal csv file
for i in range (1,48):
    if(normal_packet_checklist[i] == 0) : # Packet is not in cluster
        tmp_list = []
        for j in range (i+1,48):
            packet_1 = normal_data[normal_data["packetnum"]==i] # i
            packet_2 = normal_data[normal_data["packetnum"]==j] # i+1 
            if Similarity_binary(packet_1, packet_2) > 0.7:
                tmp_list.append(j)
                normal_packet_checklist[j] = 1     # Packet is in cluster
        normal_packet_family_list.append({'Parent':i, 'Child': tmp_list})
        normal_packet_parent_list.append(i)
        normal_packet_checklist[i] = 1

print('------Normal----')
print(normal_packet_parent_list)
print(normal_packet_family_list)


# Main logic for malware packets
malware_packet_family_list = []         # Each cluster
malware_packet_parent_list = []
malware_packet_checklist = [0]*80      # Check if packet is in cluster
malware_data = pd.read_csv('malware_http_final_revise.csv', encoding="euc-kr")

# 80 packets in this malware csv file
for i in range (1,80):
    if(malware_packet_checklist[i] == 0) : # Packet is not in cluster
        tmp_list = []
        for j in range (i+1,80):
            packet_1 = malware_data[malware_data["packetnum"]==i] # i
            packet_2 = malware_data[malware_data["packetnum"]==j] # i+1 
            if Similarity_binary(packet_1, packet_2) > 0.7:
                tmp_list.append(j)
                malware_packet_checklist[j] = 1     # Packet is in cluster
        malware_packet_family_list.append({'Parent':i, 'Child': tmp_list})
        malware_packet_parent_list.append(i)
        malware_packet_checklist[i] = 1

print('------Malware-----')
print(malware_packet_parent_list)
print(malware_packet_family_list)

n_p_len =len(normal_packet_parent_list)
m_p_len =len(malware_packet_parent_list)
for i in range(1, n_p_len):
    for j in range(1, m_p_len):
        packet_1 = normal_data[normal_data["packetnum"]==normal_packet_parent_list[i]]
        packet_2 = malware_data[malware_data["packetnum"]==malware_packet_parent_list[j]]
        if Similarity_binary(packet_1, packet_2) > 0.6:
            print("Same Packet Family! normal_num : ", i, "  malware_num : ", j)
        else :
            print("Different Packet Family! normal_num : ", i, "  malware_num : ", j)

print("Compare End")



